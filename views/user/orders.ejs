<%- include('../../views/partials/user/header') %>

<!-- Breadcrumb Section Begin -->
<section class="breadcrumb-option">
  <div class="container">
    <div class="row">
      <div class="col-lg-12">
        <div class="breadcrumb__text">
          <div class="breadcrumb__links">
            <a href="/">Home</a>
            <a href="/my-account">My Account</a>
            <span>My Orders</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
<!-- Breadcrumb Section End -->

<section class="shop spad">
  <div class="container">
    <div class="row">
      <%- include('../../views/partials/user/acc-sidebar') %>
      <section class="accounts">
        <div class="order-body mx-2">
          <div class="d-flex justify-content-between">
            <div>
              <h4 class="section-heading">My Orders</h4>
            </div>
            <div>
              <a href="/shop" class="gen-btn"><i class='bx bxs-cart'></i> Shope Now</a>
            </div>
          </div>

          <% if (orderDetails.length === 0) { %>
          <div class="alert alert-info">You have no orders yet.</div>
          <a href="/shop" class="gen-btn">Time to Grab Your First Order</a>
          <% } %>

          <% orderDetails.reverse().forEach(order => { %>
          <div class="order-card no-radius-card">
            <div class="row align-items-center border-bottom pb-2 mb-3">

              <% if (order.status === 'Pending') { %>
              <div class="col-md-2 ">
                <button class="btn btn-danger btn-sm btn-action" onclick="cancelOrder('<%= order._id %>')">Cancel Order</button>
              </div>
              <% } %>

              <div class="col-md-6">
                <h6 class="mb-1">Order ID: <%= order.orderId %></h6>
                <p class="mb-0"><strong>Order Date:</strong> <%= new Date(order.orderDate).toLocaleString() %></p>
              </div>

              <div class="col-md-4 text-md-end">
                <p class="mb-0"><strong>Status:</strong>
                  <span class="btn-sm 
                    <% if (order.status === 'Pending') { %> bg-info text-white
                    <% } else if (order.status === 'Placed') { %> bg-info text-white
                    <% } else if (order.status === 'Shipped') { %> bg-primary text-white
                    <% } else if (order.status === 'Delivered') { %> bg-success  text-white
                    <% } else if (order.status === 'Returned') { %> bg-secondary text-white
                    <% } else if (order.status === 'Cancelled') { %> bg-danger text-white
                    <% } else if (order.status === 'Cancel Request') { %> bg-danger text-white
                    <% } %> mx-2">
                    <% if (order.status === 'Cancel Request') { %>
                    Canacellation Requested
                    <%}else { %>
                    <%= order.status %>
                    <% } %>
                  </span>
                </p>
              </div>
            </div>

            <div class="row">
              <div class="col-md-6">
                <p><strong>Final Price:</strong> ₹ <%= (order.finalAmount).toLocaleString('en-IN', { minimumFractionDigits: 1, maximumFractionDigits: 2 })  %></p>
              </div>
              <div class="col-md-6">
                <p><strong>Discount:</strong> ₹ <%= (order.discount).toLocaleString('en-IN', { minimumFractionDigits: 1, maximumFractionDigits: 2 }) %></p>
              </div>
            </div>

            <div class="row">
              <div class="col-md-6">
                <p><strong>Payment Method:</strong> <%= order.paymentMethod %></p>
              </div>
              <div class="col-md-6">
                <p><strong>Payment Status:</strong> <span class="badge text-white bg-<%= order.paymentStatus === 'Pending' ? 'warning' : 'success' %>"><%= order.paymentStatus %></span></p>
              </div>
            </div>


            <h6 class="mt-4">Order Items</h6>
            <table class="order-table">
              <thead>
                <tr>
                  <th>Product Name</th>
                  <th>Color</th>
                  <th>Size</th>
                  <th>Quantity</th>
                  <th>Price</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                <% order.items.reverse().forEach(item => { %>
                <tr>
                  <td><%= item.productName %></td>
                  <td><%= item.variantDetails.color || "N/A" %></td>
                  <td>
                    <% if (item.variantDetails.size && item.variantDetails.size !== "NA") { %>
                    <%= item.variantDetails.size %>
                    <% } else { %>
                    -
                    <% } %>
                  </td>
                  <td><%= item.quantity %></td>
                  <td>₹<%= item.variantDetails.salePrice %></td>
                  <td>
                    <% if (item.itemStatus === 'Pending') { %>
                    <button class="btn btn-danger btn-sm btn-action" onclick="cancelItemOrder('<%= order._id %>', '<%= item.productId %>', '<%= item.variantIndex %>')">Cancel
                    </button>
                    <% } %>
                    <% if (item.itemStatus === 'Delivered') { %>
                    <button class="btn btn-warning btn-sm btn-action text-white" onclick="returnItem('<%= order._id %>', '<%= item.productId %>', '<%= item.variantIndex %>')">Return
                    </button>
                    <% } %>
                  </td>
                </tr>
                <% }) %>
              </tbody>
            </table>
          </div>
          <% }) %>

        </div>
      </section>
    </div>
  </div>
</section>




<!-- Footer Section -->
<%- include('../../views/partials/user/footer') %>

<!-- Search Begin -->
<div class="search-model">
  <div class="h-100 d-flex align-items-center justify-content-center">
    <div class="search-close-switch">+</div>
    <form class="search-model-form">
      <input type="text" id="search-input" placeholder="Search here.....">
    </form>
  </div>
</div>
<!-- Search End -->

<script>
  async function cancelOrder(orderId) {
    Swal.fire({
      title: "Are you sure?",
      text: "Do you really want to request cancellation?",
      icon: "warning",
      showCancelButton: true,
      confirmButtonColor: "#d33",
      cancelButtonColor: "#3085d6",
      confirmButtonText: "Yes, request cancel"
    }).then(async (result) => {
      if (result.isConfirmed) {
        try {
          const response = await fetch(`/orders/${orderId}/cancel`, {
            method: "PATCH",
            headers: {
              "Content-Type": "application/json"
            }
          });

          const data = await response.json();

          if (response.ok) {
            Swal.fire("Cancelled!", data.message, "success").then(() => {
              location.reload();
            });
          } else {
            Swal.fire("Error!", data.message, "error");
          }
        } catch (error) {
          console.error("Error cancelling order:", error);
          Swal.fire("Error!", "Something went wrong. Try again.", "error");
        }
      }
    });
  }
</script>

<script>
  async function cancelItemOrder(orderId, productId, variantIndex) {
    Swal.fire({
      title: "Are you sure?",
      text: "Do you really want to request cancellation for this item?",
      icon: "warning",
      showCancelButton: true,
      confirmButtonColor: "#d33",
      cancelButtonColor: "#3085d6",
      confirmButtonText: "Yes, request cancel"
    }).then(async (result) => {
      if (result.isConfirmed) {
        try {
          const response = await fetch(`/orders/${orderId}/cancel-item`, {
            method: "PATCH",
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify({
              productId,
              variantIndex
            })
          });

          const data = await response.json();

          if (response.ok) {
            Swal.fire("Cancelled!", data.message, "success").then(() => {
              location.reload();
            });
          } else {
            Swal.fire("Error!", data.message, "error");
          }
        } catch (error) {
          console.error("Error cancelling item:", error);
          Swal.fire("Error!", "Something went wrong. Try again.", "error");
        }
      }
    });
  }
</script>